name: CetaHouseCache
catch_rules:
  - rule: ^https\:\/\/((cdn|fastly|gcore|test1|quantil)\.jsdelivr\.net\/npm|unpkg\.com)
    transform_rules:
      - search: _
        replace:
          - _
          - https://jsd.cdn.storisinz.site/npm
          - https://npm.webcache.cn

  - rule: ^https\:\/\/cdnjs\.cloudflare\.com\/ajax\/libs
    transform_rules:
      - search: _
        replace:
          - _
          - https://cdnjs.webstatic.cn/ajax/libs
          - https://cdnjs.cdn.storisinz.site/ajax/libs
          - https://cdnjs.onmicrosoft.cn/ajax/libs

  - rule: ^https\:\/\/((cdn|fastly|gcore|test1|quantil)\.jsdelivr\.net\/gh)
    transform_rules:
      - search: _
        replace:
          - _
          - https://jsd.cdn.storisinz.site/gh
          - https://code.webcache.cn/gh

  - rule: _ #ClientWorker语法糖，匹配当前域，返回一个域名带端口
    transform_rules: #转换规则，最上面的优先最高
      - search: \#.* #在发送请求时匹配#后内容并移除
        searchin: url
        replace: ''
      - search: \?.* #在发送请求时匹配?后内容并移除，仅限静态请求
        replace: ''
      - search: ([^\/.]+)\/index(|\.html)$ #优化url
        action: redirect
        redirect: 
          to: $1/
      - search: boringbay\.com #绕过boringbay
        action: skip
      - search: tk\.pl\.blog\.sinzmise\.top #绕过twikoo后端
        action: skip
      - search: ([^\/.]+)\/$  #解析index.html
        replace: $1/index.html
      - search: _
        replace:
          - _ #保留原始请求
          - vercel.blog.sinzmise.top #Vercel托管
          - jsdnpm/npm/sinzmise-cetastories #npm托管
          - jsdgithub/gh/SinzMise/blog@zh #gh托管

      - search: ^https\:\/\/jsdnpm
        replace:
          - https://cdn.jsdelivr.net/npm
          - https://jsd.onmicrosoft.cn/npm
          - https://unpkg.onmicrosoft.cn
          - https://unpkg.com
          - https://jsd.cdn.storisinz.site/npm
        action: fetch
        fetch:
          status: 200
          engine: parallel
          preflight: false
          timeout: 5000
          cache:
            expire: 1000*10
            delay: 3000

      - search: ^https\:\/\/jsdgithub
        replace:
          - https://jsd.onmicrosoft.cn/gh
          - https://jsd.cdn.storisinz.site/gh
        action: fetch
        fetch:
          status: 200
          engine: parallel
          preflight: false
          timeout: 5000
          cache:
            expire: 1000*10
            delay: 3000

      - search: \.html$
        header:
          content-type: text/html;charset=utf-8 #修复标头
          ServerProvide: ClientWorker

  - rule: .*
    transform_rules:
      - search: .*
        action: fetch
        fetch:
          enable: true
          engine: fetch
          preflight: false
        
      - search: (^4|^5)
        searchin: status
        action: return
        return: 
          body: Error!
          header:
            content-type: text/plain;charset=utf-8
            ServerProvide: ClientWorker
          status: 503
